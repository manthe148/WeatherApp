{% extends 'base.html' %}
{% load static %} {# Ensure static is loaded #}

{% block title %}User Settings{% endblock %}

{% block content %}
<h2>User Settings for {{ user.username }}</h2>

{# Message display area - FIXED STYLE ATTRIBUTE #}
{% if messages %}
  <ul class="messages" style="list-style: none; padding: 0; margin: 1em 0;">
    {% for message in messages %}
      <li{% if message.tags %} class="{{ message.tags }}" style="padding: 10px; border: 1px solid; margin-bottom: 10px; border-radius: 4px; {% if message.level == 25 %} background-color: #dff0d8; border-color: #d6e9c6; color: #3c763d; {% elif message.level >= 40 %} background-color: #f2dede; border-color: #ebccd1; color: #a94442; {% elif message.level >= 30 %} background-color: #fcf8e3; border-color: #faebcc; color: #8a6d3b; {% else %} background-color: #d9edf7; border-color: #bce8f1; color: #31708f;{% endif %}" {% endif %}>
        {{ message }}
      </li>
    {% endfor %}
  </ul>
{% endif %}
{# End message display #}

<hr>
<h3>Subscription Status</h3>
<p>You are currently on the <strong>{% if is_subscriber %}Premium{% else %}Free{% endif %}</strong> tier.</p>
<p>(Allows saving up to {{ max_locations }} location{{ max_locations|pluralize }}.)</p>
{% if not is_subscriber %}
<p><a href="{% url 'subscriptions:plan_selection' %}">Upgrade to Premium?</a></p>
{% endif %}

<hr>
<h3>Saved Weather Locations</h3>
{% if saved_locations %}
    <ul style="list-style: none; padding: 0;">
        {% for loc in saved_locations %}
            <li style="border: 1px solid #eee; padding: 10px; margin-bottom: 10px; border-radius: 4px;">
                <strong>{{ loc.location_name }}</strong><br>
                <small>(Lat: {{ loc.latitude }}, Lon: {{ loc.longitude }})</small>
                {# Delete Form for this location - FIXED STYLE ATTRIBUTE #}
                <form method="post" action="{% url 'accounts:settings' %}" style="display: inline; margin-left: 15px;">
                    {% csrf_token %}
                    <input type="hidden" name="delete_location" value="{{ loc.pk }}">
                    <button type="submit" onclick="return confirm('Are you sure you want to delete this location?');" style="color: red; background: none; border: none; padding: 0; cursor: pointer; text-decoration: underline;">Delete</button>
                </form>
            </li>
        {% endfor %}
    </ul>
{% else %}
    <p>You have no saved locations.</p>
{% endif %}

{# --- Conditionally show Add Forms --- #}
{% if can_add_location %}
    <hr>
    <h4>Add New Location</h4>
    {# Manual Location Form #}
    <form method="post" action="{% url 'accounts:settings' %}" style="margin-top: 1em;">
        {% csrf_token %}
        <label for="manual_location">Enter Location:</label><br>
        <input type="text" id="manual_location" name="manual_location" placeholder="City, State or ZIP Code" required size="40">
        <button type="submit" name="add_manual_location">Add Manual Location</button>
    </form>

    {# Browser Geolocation Button #}
    <div style="margin-top: 1em;">
        <button type="button" id="use-location-btn">Use My Current Location</button>
        <span id="geo-status" style="margin-left: 10px; font-style: italic;"></span> {# Geolocation status messages #}
    </div>

    {# Hidden form for Geolocation #}
    <form method="post" action="{% url 'accounts:settings' %}" id="geo-form" style="display: none;">
         {% csrf_token %}
         <input type="hidden" name="geo_latitude" id="geo_latitude">
         <input type="hidden" name="geo_longitude" id="geo_longitude">
         <input type="hidden" name="save_geo_location" value="1">
    </form>
{% else %}
     <p style="margin-top: 1em; font-weight: bold;">You have reached the maximum number of saved locations ({{ max_locations }}) for your plan.</p>
{% endif %}
{# --- End Conditional Add Forms --- #}

<hr> {# Optional separator #}
<h3>Alert Notifications</h3>
<p>Get notified about weather alerts for your saved locations.</p>
{# --- Add iOS Instructions Div (Initially Hidden) --- #}
<div id="ios-instructions" class="alert alert-info" style="display: none;" role="alert">
  <h4 class="alert-heading">Enable Notifications on iPhone/iPad</h4>
  <p>To receive notifications on this device, you first need to add this website to your Home Screen:</p>
  <ol>
    <li>Tap the 'Share' button <img src="{% static 'images/icons/Icon_512.jpg' %}" alt="iOS Share Icon" style="height:1.2em; vertical-align: middle;"> in Safari (usually at the bottom or top).</li>
    <li>Scroll down and tap 'Add to Home Screen'.</li>
    <li>Tap 'Add'.</li>
    <li>Close Safari and open the newly added "Weather App" icon from your Home Screen.</li>
    <li>Navigate back to this Settings page *within the Home Screen app* and then tap the 'Subscribe' button below.</li>
  </ol>
</div>
{# --- End iOS Instructions Div --- #}


{# Add 'disabled' attribute initially #}
<button type="button" id="subscribe-push-btn" class="btn btn-info" disabled>Subscribe to Alert Notifications</button>
<span id="push-status" style="margin-left: 10px; font-style: italic;"></span>

{% endblock %} {# End of content block #}


{# --- Combined & Corrected JavaScript in extra_js block --- #}
{% block extra_js %}
<script>
        // Helper function to get CSRF token from cookie (Django standard)
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

    // Helper function (keep as before)
    function urlBase64ToUint8Array(base64String) {
        // ... (same function content) ...
         const padding = '='.repeat((4 - base64String.length % 4) % 4);
         const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
         const rawData = window.atob(base64);
         const outputArray = new Uint8Array(rawData.length);
         for (let i = 0; i < rawData.length; ++i) { outputArray[i] = rawData.charCodeAt(i); }
         return outputArray;
    }

    // Function to check for iOS
    function isIOS() {
        return /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    }

    // Function to check if running as PWA/Standalone (Added to Home Screen)
    function isStandalone() {
        return window.matchMedia('(display-mode: standalone)').matches || navigator.standalone === true;
    }


    document.addEventListener('DOMContentLoaded', function() {
        console.log("Settings page JS loaded and DOM ready.");

        // --- Geolocation Logic (Keep as before) ---
        const geoButton = document.getElementById('use-location-btn');
        const geoStatus = document.getElementById('geo-status');
        const geoForm = document.getElementById('geo-form');
        const latInput = document.getElementById('geo_latitude');
        const lonInput = document.getElementById('geo_longitude');

        if (geoButton) {
            console.log("Geo button found, adding listener.");
            geoButton.addEventListener('click', function() { /* ... existing geolocation click logic ... */
                console.log("Geo button clicked!");
                 if (!geoStatus || !geoForm || !latInput || !lonInput) { console.error("Geo form elements missing..."); if(geoStatus) geoStatus.textContent='Error: Internal form elements missing.'; return; }
                 geoStatus.textContent = 'Requesting location...'; console.log("Requesting geolocation...");
                 if (!navigator.geolocation) { geoStatus.textContent = 'Geolocation not supported.'; console.error("Geolocation not supported."); }
                 else { navigator.geolocation.getCurrentPosition(geoSuccessCallback, geoErrorCallback, {enableHighAccuracy: false, timeout: 10000, maximumAge: 0}); }
            });
        } else { console.warn("Geo button (#use-location-btn) not found or not visible."); }
        function geoSuccessCallback(position) { /* ... existing success logic ... */
            const latitude = position.coords.latitude; const longitude = position.coords.longitude; console.log("Geolocation success:", latitude, longitude);
            if (!geoStatus || !geoForm || !latInput || !lonInput) { console.error("Geo form elements missing before submit!"); if(geoStatus) geoStatus.textContent = 'Error: Internal form elements missing before submit.'; return; }
            geoStatus.textContent = 'Location found! Saving...'; latInput.value = latitude; lonInput.value = longitude; console.log("Submitting hidden geo form..."); geoForm.submit();
        }
        function geoErrorCallback(error) { /* ... existing error logic ... */
            let message = 'Error retrieving location: '; switch(error.code) { case error.PERMISSION_DENIED: message += "Permission denied."; break; case error.POSITION_UNAVAILABLE: message += "Location unavailable."; break; case error.TIMEOUT: message += "Request timed out."; break; case error.UNKNOWN_ERROR: message += "Unknown error."; break; }
            if(geoStatus) { geoStatus.textContent = message; } console.error("Geolocation Error Code: " + error.code + ", Message: " + error.message);
         }
        // --- End Geolocation Logic ---


        // --- Push Notification Logic ---
        const subscribeButton = document.getElementById('subscribe-push-btn');
        const pushStatus = document.getElementById('push-status');
        const iosInstructions = document.getElementById('ios-instructions'); // Get instruction div
        const vapidPublicKey = '{{ vapid_public_key|default:"" }}';

        if (subscribeButton && pushStatus && iosInstructions) { // Check elements exist
             if (!vapidPublicKey) {
                console.error('VAPID Public Key missing.');
                pushStatus.textContent = 'Error: Push config missing.';
                subscribeButton.disabled = true;
                return; // Stop if no VAPID key
             }

             const onIOS = isIOS();
             const runningStandalone = isStandalone();
             console.log(`iOS: ${onIOS}, Standalone: ${runningStandalone}`);

             if (onIOS && !runningStandalone) {
                // On iOS but NOT running from Home Screen
                console.log("iOS detected, not standalone. Showing instructions.");
                iosInstructions.style.display = 'block'; // Show instructions
                pushStatus.textContent = 'Add to Home Screen first.';
                subscribeButton.disabled = true; // Keep button disabled
             } else if ('serviceWorker' in navigator && 'PushManager' in window && Notification) {
                // Either NOT iOS, OR IS iOS and running standalone
                console.log('Push Notifications potentially supported and allowed in this context.');
                iosInstructions.style.display = 'none'; // Hide instructions
                subscribeButton.disabled = false; // Enable the button

                subscribeButton.addEventListener('click', function() {
                    // --- Existing subscription logic goes here ---
                    pushStatus.textContent = 'Requesting permission...';
                    Notification.requestPermission().then((permission) => {
                        if (permission === 'granted') {
                            console.log('Push permission granted.');
                            pushStatus.textContent = 'Registering service worker...';
                            navigator.serviceWorker.register('/sw.js')
                                .then(function(registration) {
                                    console.log('Service Worker registered:', registration);
                                    pushStatus.textContent = 'Subscribing...';
                                    const subscribeOptions = {
                                        userVisibleOnly: true,
                                        applicationServerKey: urlBase64ToUint8Array(vapidPublicKey)
                                    };
                                    return registration.pushManager.subscribe(subscribeOptions);
                                })
                                .then(function(subscription) {
                                    // ... (Log subscription, Send to server logic) ...
                                    console.log("Subscription JSON:", JSON.stringify(subscription));
                                    pushStatus.textContent = 'Subscribing... Sending to server...';
                                    // --- Fetch Call to Save Subscription ---
                                    fetch("{% url 'subscriptions:save_push_subscription' %}", {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                                        body: JSON.stringify(subscription.toJSON())
                                    })
                                    .then(response => { /* ... handle response ... */
                                        if (!response.ok) { return response.json().then(data => { throw new Error(data.message || `Server error: ${response.status}`); }); }
                                        return response.json();
                                    })
                                    .then(data => { /* ... update pushStatus ... */
                                        if (data.status === 'success') { console.log('Sub saved.'); pushStatus.textContent = 'Subscription active!'; }
                                        else { console.error('Server error:', data.message); pushStatus.textContent = 'Save failed: ' + (data.message || 'Unknown server error'); }
                                    })
                                    .catch(error => { /* ... update pushStatus on fetch error ... */
                                         console.error('Error sending sub:', error); pushStatus.textContent = 'Save failed: ' + error.message;
                                    });
                                    // --- End Fetch Call ---
                                })
                                .catch(function(err) { /* ... handle registration/subscribe error ... */
                                     console.error('SW registration or Push subscription failed:', err); pushStatus.textContent = 'Subscription failed: ' + err.message;
                                });
                        } else { /* ... handle permission denied ... */
                            console.warn('Push permission denied.'); pushStatus.textContent = 'Permission denied.';
                        }
                    }); // End Notification.requestPermission().then
                }); // End click listener
                // --- End Existing subscription logic ---

             } else {
                 // Push not supported by browser (outside iOS check)
                 console.warn('Push notifications or Service Workers not supported.');
                 pushStatus.textContent = 'Push not supported by this browser.';
                 subscribeButton.disabled = true;
             }
        } else {
             console.error("Push Notification related elements not found.");
        }
        // --- End Push Notification Logic ---

    }); // End DOMContentLoaded listener
</script>
{% endblock %}
